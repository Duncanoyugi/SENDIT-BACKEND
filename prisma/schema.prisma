generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  DRIVER
  ADMIN
}

enum VehicleType {
  MOTORCYCLE
  CAR
  VAN
  TRUCK
}

enum DriverApplicationStatus {
  NOT_APPLIED
  PENDING
  APPROVED
  REJECTED
}

enum ParcelStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED_TO_RECIPIENT
  DELIVERED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum NotificationType {
  PARCEL_CREATED
  PARCEL_ASSIGNED
  PARCEL_PICKED_UP
  PARCEL_IN_TRANSIT
  PARCEL_DELIVERED_TO_RECIPIENT
  PARCEL_DELIVERED
  PARCEL_COMPLETED
  DRIVER_ASSIGNED
  PAYMENT_RECEIVED
  REVIEW_RECEIVED
}

enum ReviewType {
  SERVICE
  DRIVER
  CUSTOMER
}

model User {
  id                      String   @id @default(cuid())
  email                   String   @unique
  password                String
  name                    String
  phone                   String?
  address                 String?
  role                    UserRole @default(CUSTOMER)
  isAvailable             Boolean? @default(true)

  licenseNumber           String?  @unique
  vehicleNumber           String?
  vehicleType             VehicleType?
  currentLat              Float? @map("current_lat")
  currentLng              Float? @map("current_lng")
  driverApplicationStatus DriverApplicationStatus @default(NOT_APPLIED)
  driverApplicationDate   DateTime?
  driverApplicationReason String?
  driverApprovalDate      DateTime?
  driverApprovedBy        String?
  driverRejectionReason   String?

  averageRating           Float?   @default(0)
  totalRatings            Int      @default(0)
  totalDeliveries         Int      @default(0)
  completedDeliveries     Int      @default(0)
  cancelledDeliveries     Int      @default(0)
  averageDeliveryTime     Int?
  onTimeDeliveryRate      Float?   @default(0)
  lastActiveAt            DateTime?
  totalEarnings           Float?   @default(0)

  totalParcelsEverSent    Int      @default(0)
  totalParcelsReceived    Int      @default(0)
  preferredPaymentMethod  String?

  profilePicture          String?
  isActive                Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  deletedAt               DateTime?

  sentParcels             Parcel[] @relation("SenderParcels")
  receivedParcels         Parcel[] @relation("RecipientParcels")
  assignedParcels         Parcel[] @relation("DriverParcels")

  reviewsGiven            Review[] @relation("ReviewsGiven")
  reviewsReceived         Review[] @relation("ReviewsReceived")
  notifications           Notification[]
  statusUpdates           ParcelStatusHistory[] @relation("StatusUpdates")
  deliveryProofs          DeliveryProof[] @relation("DeliveryProofs")
  confirmedDeliveries     DeliveryProof[] @relation("DeliveryConfirmations")

  @@map("users")
  @@index([name])
  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
}

model Parcel {
  id                   String   @id @default(cuid())
  trackingNumber       String   @unique

  senderId             String?
  senderName           String
  senderEmail          String
  senderPhone          String

  recipientId          String?
  recipientName        String
  recipientEmail       String
  recipientPhone       String

  driverId             String?
  assignedAt           DateTime?

  pickupAddress        String
  deliveryAddress      String
  currentLocation      String?
  status               String   @default("PENDING")
  weight               Float
  description          String?
  value                Float?
  deliveryInstructions String?
  notes                String?
  latitude             Float?
  longitude            Float?

  estimatedPickupTime    DateTime?
  actualPickupTime       DateTime?
  estimatedDeliveryTime  DateTime?
  actualDeliveryTime     DateTime?
  totalDeliveryTime      Int?
  deliveryAttempts       Int      @default(0)
  deliveryFee            Float?
  paymentStatus          String   @default("PENDING")

  deliveredToRecipient   Boolean  @default(false)
  deliveryConfirmedAt    DateTime?
  deliveryConfirmedBy    String?
  customerSignature      String?
  customerNotes          String?
  completedAt            DateTime?
  completedBy            String?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  deletedAt              DateTime?

  sender      User? @relation("SenderParcels", fields: [senderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recipient   User? @relation("RecipientParcels", fields: [recipientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  driver      User? @relation("DriverParcels", fields: [driverId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  statusHistory ParcelStatusHistory[]
  reviews       Review[]
  deliveryProof DeliveryProof?
  notifications Notification[]

  @@map("parcels")
  @@index([senderId])
  @@index([recipientId])
  @@index([driverId])
  @@index([status])
  @@index([createdAt])
}

model Review {
  id          String   @id @default(uuid())
  parcelId    String
  reviewerId  String
  revieweeId  String?

  rating      Int
  comment     String?
  reviewType  ReviewType @default(SERVICE)
  isPublic    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  parcel      Parcel @relation(fields: [parcelId], references: [id])
  reviewer    User   @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  reviewee    User?  @relation("ReviewsReceived", fields: [revieweeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}


model ParcelStatusHistory {
  id          String   @id @default(cuid())
  parcelId    String
  status      String   // was enum
  location    String?
  latitude    Float?
  longitude   Float?
  updatedBy   String?
  timestamp   DateTime @default(now())
  notes       String?
  imageUrl    String?

  parcel        Parcel @relation(fields: [parcelId], references: [id])
  updatedByUser User?  @relation("StatusUpdates", fields: [updatedBy], references: [id])

  @@map("parcel_status_history")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean  @default(false)
  actionUrl String?
  parcelId  String?
  createdAt DateTime @default(now())
  readAt    DateTime?

  user   User    @relation(fields: [userId], references: [id])
  parcel Parcel? @relation(fields: [parcelId], references: [id])

  @@map("notifications")
}

model DeliveryProof {
  id                String   @id @default(cuid())
  parcelId          String   @unique
  customerSignature String?
  recipientName     String
  deliveredAt       DateTime
  confirmedAt       DateTime
  deliveredBy       String
  confirmedBy       String
  customerNotes     String?
  driverNotes       String?

  parcel    Parcel @relation(fields: [parcelId], references: [id])
  driver    User   @relation("DeliveryProofs", fields: [deliveredBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recipient User   @relation("DeliveryConfirmations", fields: [confirmedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("delivery_proofs")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}
